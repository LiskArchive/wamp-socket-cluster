!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("jsonschema")):"function"==typeof define&&define.amd?define("wampSocketCluster",["jsonschema"],t):"object"==typeof exports?exports.wampSocketCluster=t(require("jsonschema")):e.wampSocketCluster=t(e.jsonschema)}(this,function(e){return function(e){function t(r){if(n[r])return n[r].exports;var o=n[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,t),o.l=!0,o.exports}var n={};return t.m=e,t.c=n,t.i=function(e){return e},t.d=function(e,n,r){t.o(e,n)||Object.defineProperty(e,n,{configurable:!1,enumerable:!0,get:r})},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=6)}([function(e,t,n){"use strict";function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var o,i=n(1).Validator,s=new i,u={id:"/RPCResponse",type:"object",properties:{type:{type:"string"},data:{}},required:["type","data"]},c={id:"/RPCRequest",type:"object",properties:{type:{type:"string"},procedure:{type:"string"},data:{}},required:["type","procedure"]},a={id:"/EventRequestSchema",type:"object",properties:{type:{type:"string"},procedure:{type:"string"},data:{}},required:["type","procedure"]},p={id:"/MasterRPCRequest",type:"object",properties:{type:{type:"string"},procedure:{type:"string"},data:{}},required:["type","procedure"]},d={id:"/InterProcessRPCRequestSchema",type:"object",properties:{type:{type:"string"},procedure:{type:"string"},data:{}},required:["type","procedure"]},f={id:"/MasterConfigRequestSchema",type:"object",properties:{type:{type:"string"},registeredEvents:{type:"array"},config:{type:"object"}},required:["type","registeredEvents","config"]},l=r({},u.id,c.id),y=(o={},r(o,c.id,u.id),r(o,p.id,u.id),o),v=function(e,t){return s.validate(e,t).valid&&e.type===t.id};e.exports={EventRequestSchema:a,RPCRequestSchema:c,RPCResponseSchema:u,InterProcessRPCRequestSchema:d,MasterRPCRequestSchema:p,MasterConfigRequestSchema:f,resToReqMap:l,reqToResMap:y,isValid:v}},function(e,t){e.exports=require("jsonschema")},function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var o=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),i=n(0),s=function(){function e(){r(this,e),this.endpoints={rpc:{},event:{}}}return o(e,[{key:"upgradeToWAMP",value:function(e){var t=this;return e.on("rpc-request",function(n,r){i.isValid(n,i.RPCRequestSchema)?(n.socketId=e.id,t.processWAMPRequest(n,r)):r('Failed to process RPC request "'+n.procedure+'" because the request schema was not valid')}),Object.keys(this.endpoints.event).forEach(function(n){"function"==typeof t.endpoints.event[n]&&e.on(n,t.endpoints.event[n])}),e}},{key:"processWAMPRequest",value:function(e,t){var n=this,r=function(e,t){return n.endpoints[e][t]&&"function"==typeof n.endpoints[e][t]};return r("rpc",e.procedure)?this.endpoints.rpc[e.procedure](e.data,function(e,n){t(e,{type:i.RPCResponseSchema.id,data:n})}):r("event",e.procedure)?this.endpoints.event[e.procedure](e.data):t("Procedure "+e.procedure+" not registered on WAMPServer. Available commands: "+this.endpoints)}},{key:"registerRPCEndpoints",value:function(e){this.endpoints.rpc=Object.assign(this.endpoints.rpc,e)}},{key:"registerEventEndpoints",value:function(e){this.endpoints.event=Object.assign(this.endpoints.event,e)}},{key:"reassignRPCEndpoints",value:function(e){this.endpoints.rpc=e}},{key:"reassignEventEndpoints",value:function(e){this.endpoints.event=e}}]),e}();e.exports=s},function(e,t,n){"use strict";var r={get:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:void 0;if("string"!=typeof t)return n;for(var r=t.split("."),o=e,i=0;i<r.length;i+=1)if(void 0===(o=o[r[i]]))return n;return o}};e.exports=r},function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var o=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),i=(n(3).get,n(0)),s=function(){function e(){r(this,e)}return o(e,[{key:"upgradeToWAMP",value:function(e){if(e.call)return e;var t=e;return t.call=function(t,n){return new Promise(function(r,o){return e.emit("rpc-request",{type:i.RPCRequestSchema.id,procedure:t,data:n},function(e,t){e?o(e.toString()):t?r(t.data):r()})})},t}}]),e}();e.exports=s},,function(e,t,n){"use strict";function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function s(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var u=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),c=n(1).Validator,a=(n(3).get,n(2)),p=(n(4),n(0)),d=new c,f=function(e){function t(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1e4,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:function(){};o(this,t);var u=i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return u.worker=e,u.sockets=e.scServer.clients,u.endpoints.slaveRpc={},u.config={},u.internalRequestsTimeoutMs=n,u.worker.on("masterMessage",function(e,t){p.isValid(e,p.MasterConfigRequestSchema)?(u.config=Object.assign({},u.config,e.config),e.registeredEvents&&u.registerEventEndpoints(e.registeredEvents.reduce(function(e,t){return Object.assign(e,r({},t,function(e){u.worker.sendToMaster({data:e,procedure:t,type:p.EventRequestSchema.id})}))},{})),s(null,u),s=function(){}):console.error('Received invalid master message payload of type "'+e.type+'"')}),u}return s(t,e),u(t,[{key:"sendToMaster",value:function(e,t,n){var r={type:p.InterProcessRPCRequestSchema.id,procedure:e,data:t};n?this.worker.sendToMaster(r,function(e,t){return e?n(e):n(null,t.data)}):this.worker.sendToMaster(r)}},{key:"processWAMPRequest",value:function(e,t){d.validate(e,p.RPCRequestSchema).valid&&(this.endpoints.slaveRpc[e.procedure]&&"function"==typeof this.endpoints.slaveRpc[e.procedure]?t?this.endpoints.slaveRpc[e.procedure](e,function(e,n){t(e,{type:p.RPCResponseSchema.id,data:n})}):this.endpoints.slaveRpc[e.procedure](e):(e.type=p.MasterRPCRequestSchema.id,this.worker.sendToMaster(e,t)))}},{key:"reassignRPCSlaveEndpoints",value:function(e){this.endpoints.slaveRpc=e}},{key:"registerRPCSlaveEndpoints",value:function(e){this.endpoints.slaveRpc=Object.assign(this.endpoints.slaveRpc,e)}}]),t}(a);e.exports=f}])});